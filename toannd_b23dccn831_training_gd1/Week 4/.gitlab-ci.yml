stages:
  - build
  - push
  - deploy

# ========BUILD======
# build_frontend:
#   stage: build
#   script:
#     - cd frontend
#     - npm install
#     - npm start
#   artifacts:
#     paths:
#       - frontend/dist/
#   tags:
#     - dev-server

build_backend:
  stage: build
  script:
    - cd backend
    - chmod +x gradlew
    - ./gradlew clean bootJar --no-daemon
  artifacts:
    paths:
      - backend/build/libs/
  tags:
    - dev-server
    
push_images:
  stage: push
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
  script: 

    - docker build -t "$CI_REGISTRY_IMAGE/frontend:latest" -f frontend/Dockerfile frontend/
    - docker push "$CI_REGISTRY_IMAGE/frontend:latest"
    - docker build -t "$CI_REGISTRY_IMAGE/backend:latest" -f backend/Dockerfile backend/
    - docker push "$CI_REGISTRY_IMAGE/backend:latest"
  tags:
    - dev-server

# ========DEPLOY========
deploy:
  stage: deploy
  before_script:
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan 192.168.22.150 >> ~/.ssh/known_hosts
  script:
    - ssh toannd@192.168.22.150 "cd /home/bookshop/book && docker compose pull && docker compose up -d --remove-orphans"

  tags:
    - dev-server

